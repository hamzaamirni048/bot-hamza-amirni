const settings = require('../settings');

const quizQuestions = [
    { question: "ุดูู ูู ุนุงุตูุฉ ุงููุบุฑุจุ", answer: "ุงูุฑุจุงุท", options: ["ุงูุฏุงุฑ ุงูุจูุถุงุก", "ุงูุฑุจุงุท", "ูุฑุงูุด", "ูุงุณ"] },
    { question: "ุดููู ูู ุจุทู ูุฃุณ ุงูุนุงูู 2022ุ", answer: "ุงูุงุฑุฌูุชูู", options: ["ูุฑูุณุง", "ุงูุจุฑุงุฒูู", "ุงูุงุฑุฌูุชูู", "ุงููุบุฑุจ"] },
    { question: "ุดุญุงู ุนุฏุฏ ุฑูุนุงุช ุตูุงุฉ ุงููุบุฑุจุ", answer: "3", options: ["2", "3", "4", "5"] },
    { question: "ุดูู ุณููุช ุงูุนููุฉ ุฏูุงู ุงููุงุจุงูุ", answer: "ูู", options: ["ุฏููุงุฑ", "ููุฑู", "ูู", "ูุงู"] },
    { question: "ุดููู ูู ูุฎุชุฑุน ุงููุตุจุงุญ ุงูููุฑุจุงุฆูุ", answer: "ุชููุงุณ ุงุฏูุณูู", options: ["ูููุชู", "ุงููุดุชุงูู", "ุชููุงุณ ุงุฏูุณูู", "ุบุงููููู"] },
    { question: "ุดูู ูู ุฃูุจุฑ ุฏููุฉ ูุงูุนุงูู ูู ุญูุซ ุงููุณุงุญุฉุ", answer: "ุฑูุณูุง", options: ["ุงูุตูู", "ุงูุฑููุง", "ุฑูุณูุง", "ููุฏุง"] },
    { question: "ุดุญุงู ุนุฏุฏ ุฃููุงู ููุณ ูุฒุญุ", answer: "7", options: ["5", "6", "7", "8"] },
    { question: "ุดูู ูู ุฃุณุฑุน ุญููุงู ุจุฑูุ", answer: "ุงูููุฏ", options: ["ุงูุงุณุฏ", "ุงูููุฏ", "ุงูุญุตุงู", "ุงูููุฑ"] },
    { question: "ูุงุด ูู ูุงุฑุฉ ูุงููุฉ ูุตุฑุ", answer: "ุงูุฑูููุง", options: ["ุงุณูุง", "ุงูุฑูููุง", "ุงูุฑูุจุง", "ุงูุฑููุง"] },
    { question: "ุดูู ูู ุงูุญููุงู ูู ูุนุฑูู ุจููุจ 'ุณูููุฉ ุงูุตุญุฑุงุก'ุ", answer: "ุงูุฌูู", options: ["ุงูุญุตุงู", "ุงูุฌูู", "ุงูููู", "ุงููุนุงูุฉ"] },
    { question: "ุดููู ูู ุฃูู ุฅูุณุงู ุทูุน ููููุฑุ", answer: "ููู ุงุฑูุณุชุฑููุบ", options: ["ููุฑู ุบุงุบุงุฑูู", "ููู ุงุฑูุณุชุฑููุบ", "ุจุงุฒ ุฃูุฏุฑูู", "ูุงููู ูููููุฒ"] },
    { question: "ุดูู ูู ุงููุนุฏู ูู ุฃุบูู ูู ุงูุฐูุจุ", answer: "ุงููุงุณ", options: ["ุงููุถุฉ", "ุงููุงุณ", "ุงููุญุงุณ", "ุงูุญุฏูุฏ"] },
    { question: "ุดุญุงู ูุงูู ูู ุซุงููุฉ ูุงูุฏูููุฉุ", answer: "60", options: ["50", "60", "30", "100"] },
    { question: "ุดูู ูู ุนุงุตูุฉ ูุฑูุณุงุ", answer: "ุจุงุฑูุณ", options: ["ููุฏู", "ูุฏุฑูุฏ", "ุจุงุฑูุณ", "ุฑููุง"] },
    { question: "ุดูู ุงูููู ูู ููุฌู ูู ุฎูุท ุงูุฃุฒุฑู ูุงูุฃุตูุฑุ", answer: "ุงูุงุฎุถุฑ", options: ["ุงูุญูุฑ", "ุงูุงุฎุถุฑ", "ุงูุจุฑุชูุงูู", "ุงูุจููุณุฌู"] },
    { question: "ุดููู ูู ูุฏุฑุจ ุงูููุชุฎุจ ุงููุบุฑุจู (ููู ุงูููุฉ)ุ", answer: "ูููุฏ ุงูุฑูุฑุงูู", options: ["ุฎููููุฒูุชุด", "ูููุฏ ุงูุฑูุฑุงูู", "ููุฑูู ุฑููุงุฑ", "ุฒุงูู"] },
    { question: "ุดูู ูู ุฃุทูู ุขูุฉ ูุงููุฑุขู ุงููุฑููุ", answer: "ุงูุฉ ุงูุฏูู", options: ["ุงูุฉ ุงููุฑุณู", "ุงูุฉ ุงูุฏูู", "ุงูุฉ ุงูููุฑ", "ุงูุฉ ุงูููู"] },
    { question: "ุดุญุงู ุนุฏุฏ ุฌูุงุช ุงูููููุฉ ุงููุบุฑุจูุฉุ", answer: "12", options: ["10", "12", "16", "9"] },
    { question: "ุดูู ูู ุฃูุจุฑ ูููุจ ูุงููุฌููุนุฉ ุงูุดูุณูุฉุ", answer: "ุงููุดุชุฑู", options: ["ุงูุงุฑุถ", "ุงููุดุชุฑู", "ุฒุญู", "ุงููุฑูุฎ"] },
    { question: "ุดููู ุงููู ุฑุณู ููุญุฉ ุงููููุงููุฒุงุ", answer: "ููููุงุฑุฏู ุฏุงูููุดู", options: ["ุจููุงุณู", "ูุงู ุฌูุฎ", "ููููุงุฑุฏู ุฏุงูููุดู", "ูุงููู ุฃูุฌูู"] },
    { question: "ุดูู ูู ุงูุนููุฉ ุฏูุงู ุงูุณุนูุฏูุฉุ", answer: "ุงูุฑูุงู", options: ["ุงูุฏุฑูู", "ุงูุฏููุงุฑ", "ุงูุฑูุงู", "ุงูููุฑุฉ"] },
    { question: "ุดููู ูู ุฃูู ุงูุฎููุงุก ุงูุฑุงุดุฏููุ", answer: "ุงุจู ุจูุฑ ุงูุตุฏูู", options: ["ุนูุฑ ุจู ุงูุฎุทุงุจ", "ุนูู ุจู ุงุจู ุทุงูุจ", "ุนุซูุงู ุจู ุนูุงู", "ุงุจู ุจูุฑ ุงูุตุฏูู"] },
    { question: "ุดูู ูู ุฃุณุฑุน ุดูุก ูุงููููุ", answer: "ุงูุถูุก", options: ["ุงูุตูุช", "ุงูุถูุก", "ุงูุตุงุฑูุฎ", "ุงูุจุฑู"] },
    { question: "ุดุญุงู ุนุฏุฏ ุฃุณูุงู ุงูุฅูุณุงู ุงูุจุงูุบุ", answer: "32", options: ["28", "30", "32", "34"] },
    { question: "ุดูู ูู ุนุงุตูุฉ ุฅูุทุงููุงุ", answer: "ุฑููุง", options: ["ูููุงู", "ุฑููุง", "ูุงุจููู", "ุงูุจูุฏููุฉ"] },
    { question: "ุดููู ูู ููุชุดู ุงูุฌุงุฐุจูุฉุ", answer: "ูููุชู", options: ["ุงููุดุชุงูู", "ูููุชู", "ุชุณูุง", "ุงุฏูุณูู"] },
    { question: "ุดูู ูู ุงูุญููุงู ุงููู ูุง ูููุนุณุดุ", answer: "ุณูู ุงููุฑุด", options: ["ุงูููู", "ุณูู ุงููุฑุด", "ุงูุฏูููู", "ุงูุงุณุฏ"] },
    { question: "ุดูู ูู ุฃูุจุฑ ูุญูุท ูุงูุนุงููุ", answer: "ุงููุญูุท ุงููุงุฏู", options: ["ุงููุญูุท ุงูุงุทูุณู", "ุงููุญูุท ุงูููุฏู", "ุงููุญูุท ุงููุงุฏู", "ุงููุญูุท ุงููุชุฌูุฏ"] },
    { question: "ุดููู ูู ูุคูู ุณูุณูุฉ ูุงุฑู ุจูุชุฑุ", answer: "ุฌ.ู. ุฑููููุบ", options: ["ุชููููู", "ุฌ.ู. ุฑููููุบ", "ุณุชููู ูููุบ", "ุฌูุฑุฌ ูุงุฑุชู"] },
    { question: "ุดูู ูู ุงููุฏููุฉ ุงูุญูุฑุงุก ูุงููุบุฑุจุ", answer: "ูุฑุงูุด", options: ["ูุงุณ", "ูููุงุณ", "ูุฑุงูุด", "ุงูุฑุจุงุท"] },
    { question: "ุดุญุงู ุนุฏุฏ ุฃูุงู ุงูุณูุฉ ุงููุจูุณุฉุ", answer: "366", options: ["365", "364", "366", "360"] },
    { question: "ุดูู ูู ุงูุนูุตุฑ ุงูููููุงุฆู ุงููู ุงูุฑูุฒ ุฏูุงูู Oุ", answer: "ุงูุฃูุณุฌูู", options: ["ุงูุฐูุจ", "ุงููุถุฉ", "ุงูุฃูุณุฌูู", "ุงูุญุฏูุฏ"] },
    { question: "ุดููู ูู ููู ุงูุบุงุจุฉุ", answer: "ุงูุงุณุฏ", options: ["ุงูููุจุฑ", "ุงูุงุณุฏ", "ุงูููู", "ุงูุฐุฆุจ"] },
    { question: "ุดูู ูู ุนุงุตูุฉ ูุตุฑุ", answer: "ุงููุงูุฑุฉ", options: ["ุงูุงุณููุฏุฑูุฉ", "ุงููุงูุฑุฉ", "ุงูุฌูุฒุฉ", "ุงูุงูุตุฑ"] },
    { question: "ุดูู ูู ุฃุทูู ููุฑ ูุงูุนุงููุ", answer: "ุงูููู", options: ["ุงูุงูุงุฒูู", "ุงูููู", "ุงููุฑุงุช", "ุงูุฏุงููุจ"] },
    { question: "ุดุญุงู ุนุฏุฏ ูุงุนุจู ูุฑูู ูุฑุฉ ุงููุฏู ุฏุงุฎู ุงูููุนุจุ", answer: "11", options: ["10", "11", "9", "12"] },
    { question: "ุดูู ูู ููู ุงูุตูุฏูู ุงูุฃุณูุฏ ูุงูุทูุงุฑุฉุ", answer: "ุจุฑุชูุงูู", options: ["ุงุณูุฏ", "ุงุญูุฑ", "ุงุตูุฑ", "ุจุฑุชูุงูู"] },
    { question: "ุดููู ูู ุงููุจู ุงููู ุงุจุชูุนู ุงูุญูุชุ", answer: "ูููุณ", options: ["ููุณู", "ูููุณ", "ููุณู", "ุนูุณู"] },
    { question: "ุดูู ูู ุงูุฏููุฉ ุงููู ุนูุฏูุง ุฃูุจุฑ ุนุฏุฏ ุฏูุงู ุงูุณูุงูุ", answer: "ุงูููุฏ", options: ["ุงูุตูู", "ุงูููุฏ", "ุงูุฑููุง", "ุฑูุณูุง"] }, // ุงูููุฏ ุชุฌุงูุฒุช ุงูุตูู ูุคุฎุฑุง
    { question: "ุดูู ูู ุงูุทุงุฆุฑ ุงููู ููููุฏ ููุง ููุจูุถุดุ", answer: "ุงูุฎูุงุด", options: ["ุงููุนุงูุฉ", "ุงูุฎูุงุด", "ุงูุจุทุฑูู", "ุงููุณุฑ"] },
    { question: "ุดุญุงู ุนุฏุฏ ุณูุฑ ุงููุฑุขู ุงููุฑููุ", answer: "114", options: ["110", "114", "120", "100"] },
    { question: "ุดูู ูู ุงููุนุฏู ุงูุณุงุฆูุ", answer: "ุงูุฒุฆุจู", options: ["ุงูุญุฏูุฏ", "ุงูุฒุฆุจู", "ุงูุฐูุจ", "ุงููุญุงุณ"] },
    { question: "ุดููู ูู ูุคุณุณ ุดุฑูุฉ ูุงููุฑูุณููุชุ", answer: "ุจูู ุบูุชุณ", options: ["ุณุชูู ุฌูุจุฒ", "ุจูู ุบูุชุณ", "ุฅูููู ูุงุณู", "ูุงุฑู ุฒููุฑุจูุฑุบ"] },
    { question: "ุดูู ูู ุนุงุตูุฉ ุฅุณุจุงููุงุ", answer: "ูุฏุฑูุฏ", options: ["ุจุฑุดูููุฉ", "ูุฏุฑูุฏ", "ุงุดุจูููุฉ", "ูุงููุณูุง"] },
    { question: "ุดูู ูู ุงูุญููุงู ุงููู ููุดู ุจูุณุงููุ", answer: "ุงูุชุนูุจุงู", options: ["ุงูููุจ", "ุงููุท", "ุงูุชุนูุจุงู", "ุงูุถูุฏุน"] },
    { question: "ูุงุด ูู ุนุงู ุงุณุชุงูู ุงููุบุฑุจุ", answer: "1956", options: ["1944", "1956", "1966", "1953"] },
    { question: "ุดูู ูู ุฃุนูู ุฌุจู ูุงููุบุฑุจุ", answer: "ุชูุจูุงู", options: ["ุงููุง", "ุชูุจูุงู", "ุงูุนูุงุดู", "ูููู"] },
    { question: "ุดูู ูู ุงูุนููุฉ ุงูุฑูููุฉ ุงูุฃุดูุฑุ", answer: "ุงูุจูุชูููู", options: ["ุงูุงูุซูุฑููู", "ุงูุจูุชูููู", "ุงูุฑูุจู", "ุงูุฏูุฌูููู"] },
    { question: "ุดููู ูู ุงููุฏุงู ุงูุชุงุฑูุฎู ููุฃุณ ุงูุนุงููุ", answer: "ูููุฒู", options: ["ุฑููุงูุฏู", "ููุณู", "ูููุฒู", "ุจูููู"] },
    { question: "ุดูู ูู ุงููููุจ ุงูุฃุญูุฑุ", answer: "ุงููุฑูุฎ", options: ["ุงููุดุชุฑู", "ุงููุฑูุฎ", "ุฒุญู", "ุงูุฒูุฑุฉ"] },
    { question: "ุดุญุงู ุนุฏุฏ ูููุจ ุงูุฃุฎุทุจูุทุ", answer: "3", options: ["1", "2", "3", "4"] },
    { question: "ุฃูู ููุฌุฏ ุชูุซุงู ุงูุญุฑูุฉุ", answer: "ูููููุฑู", options: ["ูุงุดูุทู", "ูููููุฑู", "ุจุงุฑูุณ", "ููุฏู"] },
    { question: "ุดูู ูู ูุบุฉ ุงูุจุฑูุฌุฉ ุงููู ููุฎุฏูู ุจููุง ุฏุงุจุงุ", answer: "ุฌุงูุงุณูุฑูุจุช", options: ["ุจุงูุซูู", "ุฌุงูุง", "ุฌุงูุงุณูุฑูุจุช", "ุณู ุจูุณ ุจูุณ"] },
    { question: "ุดููู ูู ูุฎุชุฑุน ุงููุงุชูุ", answer: "ุบุฑุงูุงู ุจูู", options: ["ุงุฏูุณูู", "ุชุณูุง", "ุบุฑุงูุงู ุจูู", "ูุงุฑูููู"] }
];

// Map to store active quiz sessions per chat
const activeQuizzes = new Map();

// Helper to normalize text for better matching
function normalizeText(text) {
    if (!text) return "";
    return text.trim().toLowerCase()
        .replace(/[ุฃุฅุข]/g, "ุง")
        .replace(/ุฉ/g, "ู")
        .replace(/ู/g, "ู")
        .replace(/[\u064B-\u0652]/g, "") // Remove Tashkeel
        .replace(/\s+/g, " ");
}

async function quizCommand(sock, chatId, msg, args) {
    // If user answers
    if (activeQuizzes.has(chatId) && args.length > 0) {
        const session = activeQuizzes.get(chatId);
        const userInput = args.join(' ').trim();
        const normalizedInput = normalizeText(userInput);
        const normalizedAnswer = normalizeText(session.answer);

        // 1. Check if user input is the option number
        const optNumber = parseInt(userInput);
        const isOptionNumberMatched = !isNaN(optNumber) && session.options[optNumber - 1] === session.answer;

        // 2. Check for exact or normalized match
        const isTextMatched = normalizedInput === normalizedAnswer ||
            (normalizedInput.length > 2 && normalizedAnswer.includes(normalizedInput)) ||
            (normalizedAnswer.length > 2 && normalizedInput.includes(normalizedAnswer));

        if (isOptionNumberMatched || isTextMatched) {
            await sock.sendMessage(chatId, { text: `โ *ุจุฑุงูู ุนููู!* ุงูุฌูุงุจ ุตุญูุญ: ${session.answer} ๐` }, { quoted: msg });
            activeQuizzes.delete(chatId);
            return;
        } else {
            // Check if it's a number but wrong option
            if (!isNaN(optNumber) && optNumber > 0 && optNumber <= session.options.length) {
                await sock.sendMessage(chatId, { text: `โ *ุฌูุงุจ ุบูุท!* ุญุงูู ูุฑุฉ ุฃุฎุฑู.` }, { quoted: msg });
                return;
            }
        }
    }

    // Start new quiz
    const q = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];

    // Store session
    activeQuizzes.set(chatId, q);

    let optionsText = "";
    q.options.forEach((opt, index) => {
        optionsText += `${index + 1}. ${opt}\n`;
    });

    const text = `๐ง *ูุนุจุฉ ูุณุงุจูุฉ ุงููุนุฑูุฉ* ๐ง\n\nโ *ุงูุณุคุงู:* ${q.question}\n\n๐ *ุงูุฎูุงุฑุงุช:*\n${optionsText}\n\n๐ก *ูููุดุงุฑูุฉ:* ุงูุชุจ ุงูุฌูุงุจ ุงูุตุญูุญ ูุงูุดุงุช.\n\nโ๏ธ ${settings.botName}`;

    await sock.sendMessage(chatId, { text: text }, { quoted: msg });
}

module.exports = quizCommand;
