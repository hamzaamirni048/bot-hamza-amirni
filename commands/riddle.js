const settings = require('../settings');

const riddles = [
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙŠÙ…Ø´ÙŠ Ø¨Ù„Ø§ Ø±Ø¬Ù„ÙŠÙ† ÙˆÙŠØ¨ÙƒÙŠ Ø¨Ù„Ø§ Ø¹ÙŠÙ†ÙŠÙ†ØŸ", answer: "Ø§Ù„Ø³Ø­Ø§Ø¨", hint: "ÙƒØ§ÙŠÙ† ÙØ§Ù„Ø³Ù…Ø§Ø¡" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙÙ…Ùˆ ÙÙƒØ±Ø´ÙˆØŒ ÙˆÙ„Ø§ ÙƒÙ„Ø§ ÙŠØ¨Ø§Øª ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø±Ø§Ø¦Ø­Ø©ØŸ", answer: "Ø§Ù„Ù…Ø¬Ù…Ø±", hint: "ÙƒÙ†Ø·ÙŠØ¨Ùˆ Ø¹Ù„ÙŠÙ‡" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ù‚Ø¯ Ø§Ù„Ù†Ù…Ù„Ø© ÙˆØªÙ‡Ø² Ø§Ù„Ø­Ù…Ù„Ø©ØŸ", answer: "Ø§Ù„Ù…Ù„Ø¹Ù‚Ø©", hint: "ÙƒÙ†Ø§ÙƒÙ„Ùˆ Ø¨Ù‡Ø§" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø´ÙŠ Ø­Ø§Ø¬Ø© ÙƒØªØ¯Ø®Ù„ Ù†Ø§Ø´ÙØ© ÙˆÙƒØªØ®Ø±Ø¬ ÙØ§Ø²ÙƒØ©ØŸ", answer: "Ø§Ù„Ø®Ø¨Ø²", hint: "ÙƒÙ†Ø§ÙƒÙ„ÙˆÙ‡" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùˆ Ø³Ù†Ø§Ù† ÙˆÙ…Ø§ ÙƒÙŠØ¹Ø¶Ø´ØŸ", answer: "Ø§Ù„Ù…Ø´Ø·Ø©", hint: "ÙƒÙ†Ù‚Ø§Ø¯Ùˆ Ø¨ÙŠÙ‡Ø§ Ø§Ù„Ø´Ø¹Ø±" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙŠØ³Ù…Ø¹ Ø¨Ù„Ø§ ÙˆØ°Ù†ÙŠÙ† ÙˆÙƒÙŠØªÙƒÙ„Ù… Ø¨Ù„Ø§ Ù„Ø³Ø§Ù†ØŸ", answer: "Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†", hint: "ÙƒÙ„Ø´ÙŠ Ø¹Ù†Ø¯Ùˆ" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø´Ù†Ùˆ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ù„ÙŠ ÙƒÙ„Ù…Ø§ Ø®Ø¯ÙŠØªÙŠ Ù…Ù†Ùˆ ÙƒÙŠÙƒØ¨Ø±ØŸ", answer: "Ø§Ù„Ø­ÙØ±Ø©", hint: "ÙØ§Ù„Ø£Ø±Ø¶" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¨ÙŠØ¶Ø§Ø¡ ÙƒØ§Ù„Ø«Ù„Ø¬ØŒ Ø³ÙˆØ¯Ø§Ø¡ ÙƒØ§Ù„Ù„ÙŠÙ„ØŒ Ø£ÙƒØ§Ù„Ù‡Ø§ Ø­Ø±Ø§Ù…ØŒ ÙˆØ´Ø±Ø¨Ù‡Ø§ Ø­Ù„Ø§Ù„ØŸ", answer: "Ø§Ù„Ù…Ù‚Ø¨Ø±Ø©", hint: "Ù…ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØªÙ‰" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙŠØ­Ùƒ Ø¸Ù‡Ø±Ùˆ Ø¨Ù„Ø§ ÙŠØ¯ÙŠÙ†ØŸ", answer: "Ø§Ù„Ø¨Ø§Ø¨", hint: "ÙƒÙŠØªØ­Ù„ ÙˆÙŠØªØ³Ø¯" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø®Ø§Ù„ØªÙƒ Ø®Øª Ø¨Ø§Ø·ØŒ Ø®Ø§Ù„ ÙˆÙ„Ø¯Ù‡Ø§ Ø´ÙƒÙˆÙ† ÙŠØ¬ÙŠÙƒØŸ", answer: "Ø¨Ø§Ùƒ", hint: "Ù…Ù† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¨Ù„Ø§Ø¯ ÙƒØ­Ù„Ø© ÙˆÙ†Ø§Ø³Ù‡Ø§ Ø¹Ø¨ÙŠØ¯ØŒ ÙˆÙ…ÙØªØ§Ø­Ù‡Ø§ Ø­Ø¯ÙŠØ¯ØŸ", answer: "Ø§Ù„Ø¯Ù„Ø§Ø­", hint: "ÙØ§ÙƒÙ‡Ø© ØµÙŠÙÙŠØ©" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùˆ Ø§Ù„Ø¹ÙŠÙ† ÙˆÙ…Ø§ ÙƒÙŠØ´ÙˆÙØ´ØŸ", answer: "Ø§Ù„Ø¨Ø±Ø©", hint: "ÙƒÙ†Ø®ÙŠØ·Ùˆ Ø¨ÙŠÙ‡Ø§" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø´Ù†Ùˆ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ù„ÙŠ ÙƒÙŠÙƒÙˆÙ† Ø·ÙˆÙŠÙŠÙŠÙŠÙ„ Ù…Ù„ÙŠ ÙƒÙŠÙƒÙˆÙ† ØµØºÙŠØ±ØŒ ÙˆÙƒÙŠÙ‚ØµØ§Ø± Ù…Ù„ÙŠ ÙƒÙŠÙƒØ¨Ø±ØŸ", answer: "Ø§Ù„Ø´Ù…Ø¹Ø©", hint: "ÙƒÙ†Ø¶ÙˆÙŠÙˆ Ø¨ÙŠÙ‡Ø§" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙŠØ­ÙŠÙŠ Ø§Ù„Ù…ÙŠØª ÙˆÙŠÙ…ÙŠØª Ø§Ù„Ø­ÙŠØŸ", answer: "Ø§Ù„Ù…Ø§Ø¡", hint: "Ø³Ø± Ø§Ù„Ø­ÙŠØ§Ø©" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø·ÙŠØ± Ø·Ø§Ø± ÙØ§Ù„Ø¯ÙˆØ§Ø±ØŒ Ù„Ø§ Ø±ÙŠØ´ Ù„Ø§ Ù…Ù†Ù‚Ø§Ø±ØŸ", answer: "Ø§Ù„Ø¯Ø®Ø§Ù†", hint: "ÙƒÙŠØ·Ù„Ø¹ Ù…Ù† Ø§Ù„Ø¹Ø§ÙÙŠØ©" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙŠØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ø± Ø¨Ù„Ø§ Ù…Ø§ ÙŠØªØ­Ø±ÙƒØŸ", answer: "Ø§Ù„Ø­ÙŠØ·", hint: "Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ÙŠØª" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙŠØ´ÙˆÙ ÙƒÙ„Ø´ÙŠ ÙˆÙ…Ø§ Ø¹Ù†Ø¯ÙˆØ´ Ø¹ÙŠÙ†ÙŠÙ†ØŸ", answer: "Ø§Ù„Ù…Ø±Ø§ÙŠØ©", hint: "ÙƒÙ†Ø´ÙˆÙÙˆ ÙÙŠÙ‡Ø§ Ø±Ø§Ø³Ù†Ø§" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ù‚Ø¯Ùˆ Ù‚Ø¯ Ø§Ù„ÙØ§Ø± ÙˆØµÙˆØªÙˆ ÙØ§Ù„Ø¯Ø§Ø±ØŸ", answer: "Ø§Ù„Ù…Ù†Ø¨Ù‡", hint: "ÙƒÙŠÙÙŠÙ‚Ù†Ø§ ÙØ§Ù„ØµØ¨Ø§Ø­" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ù…Ù„ÙŠ ÙƒÙŠÙ…Ø´ÙŠ ÙƒÙŠÙ…Ø´ÙŠØŒ ÙˆÙ…Ù„ÙŠ ÙƒÙŠØ¬ÙŠ ÙƒÙŠØ±Ø¬Ø¹ØŸ", answer: "Ø§Ù„Ø¸Ù„", hint: "ØªØ§Ø¨Ø¹Ùƒ Ø¯ÙŠÙ…Ø§" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù†Ø¯Ùˆ Ø±Ø¬Ù„ÙŠÙ† ÙˆÙ…Ø§ ÙƒÙŠÙ…Ø´ÙŠØ´ØŸ", answer: "Ø§Ù„ÙƒØ±Ø³ÙŠ", hint: "ÙƒÙ†Ø¬Ù„Ø³Ùˆ Ø¹Ù„ÙŠÙ‡" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø´Ù†Ùˆ Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ù„ÙŠ ÙƒÙŠÙƒØªØ¨ ÙˆÙ…Ø§ ÙƒÙŠØ¹Ø±ÙØ´ ÙŠÙ‚Ø±Ø§ØŸ", answer: "Ø§Ù„Ø³ØªÙŠÙ„Ùˆ", hint: "ÙƒÙ†ÙƒØªØ¨Ùˆ Ø¨ÙŠÙ‡" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø§Ø®ØªÙƒ ÙˆÙ…ÙƒØŒ Ø¨Ù†Øª Ø®Ø§Ù„ØªÙƒØŒ Ø´Ù†ÙƒÙˆÙ† ØªØ¬ÙŠÙƒØŸ", answer: "Ø§Ø®ØªÙƒ", hint: "Ù…Ù† Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ ÙƒÙ„Ù…Ø§ Ø²Ø¯ØªÙŠ ÙÙŠÙ‡ ÙƒÙŠÙ†Ù‚ØµØŸ", answer: "Ø§Ù„Ø¹Ù…Ø±", hint: "Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø­ÙŠØ§Ø©" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ù…ÙŠØª ÙˆÙƒÙÙ†ÙˆÙ‡ØŒ ÙˆÙ…Ù†ÙŠÙ† Ø¬Ø¨Ø¯ÙˆÙ‡ Ø¹Ø§Ø´ØŸ", answer: "Ø§Ù„Ø³ÙŠÙƒØ§Ø±", hint: "ÙŠØªØ´Ø¹Ù„" },
    { question: "Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒØŒ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ù‚Ù„Ø¨Ùˆ Ø¨ÙŠØ¶ ÙˆÙƒÙŠÙƒØ­Ù„ Ù…Ù„ÙŠ ÙƒÙŠÙƒØ¨Ø±ØŸ", answer: "Ø§Ù„Ø¯Ù„Ø§Ø­", hint: "Ù…Ù† Ø§Ù„Ø¯Ø§Ø®Ù„ Ø­Ù…Ø±" }
];

// Helper to normalize Arabic text for better matching
function normalizeText(text) {
    if (!text) return "";
    return text.trim().toLowerCase()
        .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
        .replace(/Ø©/g, "Ù‡")
        .replace(/Ù‰/g, "ÙŠ")
        .replace(/[\u064B-\u0652]/g, "") // Remove Tashkeel
        .replace(/\s+/g, " ");
}

async function riddleCommand(sock, chatId, msg, args) {
    // If checking answer
    if (activeRiddles.has(chatId) && args.length > 0) {
        const session = activeRiddles.get(chatId);
        const userInput = args.join(' ').trim();
        const normalizedInput = normalizeText(userInput);
        const normalizedAnswer = normalizeText(session.answer);

        if (normalizedInput === 'hint' || normalizedInput === 'Ù…Ø³Ø§Ø¹Ø¯Ø©') {
            await sock.sendMessage(chatId, { text: `ğŸ’¡ *ØªÙ„Ù…ÙŠØ­:* ${session.hint}` }, { quoted: msg });
            return;
        } else if (normalizedInput === 'surrender' || normalizedInput === 'Ø§Ø³ØªØ³Ù„Ø§Ù…') {
            await sock.sendMessage(chatId, { text: `ğŸ³ï¸ *ØµØ§ÙÙŠ Ø§Ø³ØªØ³Ù„Ù…ØªÙŠØŸ* Ø§Ù„Ø¬ÙˆØ§Ø¨ ÙƒØ§Ù†: ${session.answer}` }, { quoted: msg });
            activeRiddles.delete(chatId);
            return;
        }

        // Smart check: exact match OR normalized match OR partial overlap
        if (normalizedInput === normalizedAnswer ||
            (normalizedInput.length > 2 && normalizedAnswer.includes(normalizedInput)) ||
            (normalizedAnswer.length > 2 && normalizedInput.includes(normalizedAnswer))) {
            await sock.sendMessage(chatId, { text: `âœ… *ØªØ¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙƒ!* Ø¬Ø¨ØªÙŠÙ‡Ø§ Ù„Ø§ØµÙ‚Ø©: ${session.answer} ğŸ‰` }, { quoted: msg });
            activeRiddles.delete(chatId);
            return;
        } else {
            // Only send error if it looks like a real attempt (more than 2 chars)
            if (userInput.length > 2) {
                await sock.sendMessage(chatId, { text: `âŒ *Ù„Ø§ Ù…Ø§Ø´ÙŠ Ù‡ÙƒØ§Ùƒ!* (ÙƒØªØ¨ 'Ù…Ø³Ø§Ø¹Ø¯Ø©' Ù„Ù„ØªÙ„Ù…ÙŠØ­ Ø£Ùˆ 'Ø§Ø³ØªØ³Ù„Ø§Ù…').` }, { quoted: msg });
            }
            return;
        }
    }

    // New riddle
    const r = riddles[Math.floor(Math.random() * riddles.length)];
    activeRiddles.set(chatId, r);

    const text = `ğŸ§© *Ø­Ø§Ø¬ÙŠØªÙƒ Ù…Ø§Ø¬ÙŠØªÙƒ* ğŸ§©\n\nğŸ¤” *Ø§Ù„Ù„ØºØ²:* ${r.question}\n\nğŸ‘‡ *Ø¨Ø§Ø´ ØªØ¬Ø§ÙˆØ¨:* ÙƒØªØ¨ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø¯ÙŠØ±ÙŠÙƒØª.\nğŸ’¡ *Ø¨ØºÙŠØªÙŠ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ* ÙƒØªØ¨ 'Ù…Ø³Ø§Ø¹Ø¯Ø©'.\nğŸ³ï¸ *ÙˆØ­Ù„ØªÙŠØŸ* ÙƒØªØ¨ 'Ø§Ø³ØªØ³Ù„Ø§Ù…'.\n\nâš”ï¸ ${settings.botName}`;

    await sock.sendMessage(chatId, { text: text }, { quoted: msg });
}

module.exports = riddleCommand;
